#!/bin/bash
set -eu

echo '+++ :house_with_garden: Setting up the environment'

source ~/cfn-env

if [[ -n "$BUILDKITE_SECRETS_BUCKET" ]] && [[ -z "$BUILDKITE_SECRETS_KEY" ]] ; then
  echo "A SecretsBucket was provided, but no encryption key via BUILDKITE_SECRETS_KEY."
  exit 1
fi

SSH_KEY_URL="${SSH_KEY_URL:-s3://${BUILDKITE_SECRETS_BUCKET}/id_rsa_github}"

if ! github_ssh_key=$(env -i aws s3 cp --sse-c --sse-c-key "$BUILDKITE_SECRETS_KEY" "$SSH_KEY_URL") ; then
  echo "Failed to download and decrypt $SSH_KEY_URL"
fi

eval `ssh-agent -s`

# startup an ssh-agent with the ssh-key
if [[ -n "${SSH_KEY_URL:-}" ]] ; then
  echo "~~~ Downloading github ssh key from $SSH_KEY_URL"
  ssh-add <(echo $github_ssh_key)
fi

if [[ $(docker ps -q | wc -l) -gt 0 ]] ; then
  echo "~~~ Stopping existing :docker: containers"
  docker stop $(docker ps -q)
fi