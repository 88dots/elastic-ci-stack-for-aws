#!/bin/bash

set -eu -o pipefail

# AWS ECR login support

# For logging into the current AWS account’s registry
if [[ -n "${AWS_ECR_LOGIN:-}" ]] ; then
  echo "~~~ Authenticating with AWS ECR"
  eval "$(aws ecr get-login)"
fi

# For logging into other AWS account’s registries
if [[ -n "${AWS_ECR_LOGIN_REGISTRY_IDS:-}" ]] ; then
  echo "~~~ Authenticating with AWS ECR"
  eval "$(aws ecr get-login --registry_ids "${AWS_ECR_LOGIN_REGISTRY_IDS}")"
fi

# Generic docker login support

: "${DOCKER_LOGIN_USER:-}"
: "${DOCKER_LOGIN_PASSWORD:-}"
: "${DOCKER_LOGIN_SERVER:-}"

if [[ -n "${DOCKER_LOGIN_USER:-}" && -n "${DOCKER_LOGIN_PASSWORD:-}" ]] ; then
  echo "~~~ Authenticating with Docker server"

  docker login --username="${DOCKER_LOGIN_USER}" --password="${DOCKER_LOGIN_PASSWORD}" "${DOCKER_LOGIN_SERVER}"

  unset DOCKER_LOGIN_USER
  unset DOCKER_LOGIN_PASSWORD
  unset DOCKER_LOGIN_SERVER
fi
