#!/bin/bash

set -eu -o pipefail

# Import BUILDKITE_AGENTS_PER_INSTANCE
eval "$(cat /var/lib/buildkite-agent/cfn-env)"

echo "Stopping buildkite-agent gracefully"

for i in $(seq 1 "${BUILDKITE_AGENTS_PER_INSTANCE}"); do
  service "buildkite-agent-${i}" stop &

  until service "buildkite-agent-${i}" status | grep -q stopped; do
    echo "Waiting for service buildkite-agent-${i} to have stopped..."
    sleep 5
  done
done

echo "buildkite-agent stopped"
